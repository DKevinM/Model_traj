<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Leaflet Particle Smoke — Safe Mode</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    html, body { height: 100%; margin: 0; }
    #map { width: 100%; height: 100%; }
    .control-bar { position:absolute; top:10px; left:10px; z-index:1000; background:rgba(255,255,255,0.95);
      padding:10px 12px; border-radius:10px; font:14px system-ui, Arial; box-shadow:0 2px 10px rgba(0,0,0,.15); }
    .control-row { display:flex; gap:10px; align-items:center; margin:6px 0; flex-wrap:wrap; }
    .btn { border:1px solid #ccc; padding:4px 10px; border-radius:6px; background:#f7f7f7; cursor:pointer; }
    .stat { opacity:.8; }
    input[type=range]{ width:160px; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="control-bar">
    <div class="control-row">
      <button id="start" class="btn">Start</button>
      <button id="stop"  class="btn">Stop</button>
      <span class="stat" id="fps">fps: —</span>
    </div>
    <div class="control-row">
      <strong>Wind</strong>
      <label>Manual <input id="manualWind" type="checkbox" checked></label>
      <label>Speed (m/s) <input id="windSpeed" type="range" min="0" max="30" step="0.1" value="5"></label>
      <label>Dir (° from) <input id="windDir" type="range" min="0" max="360" step="1" value="270"></label>
      <span class="stat" id="windStat">wind: —</span>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
  <script defer>
  console.log("plume: script starting");
  window.addEventListener('DOMContentLoaded', () => {
    console.log("plume: DOM ready");

    // --- Declarations first ---
    const R = 6371000, toDeg = 180/Math.PI;
    let running = false, maxTrail = 6, maxLifesec = 18;
    let manual = true, manualSpeed = 5.0, manualDir = 270;
    let wind = {u:0,v:0,speed:0,dir:0};
    const particles = [];

    // --- Map ---
    const map = L.map('map', { preferCanvas:true }).setView([53.5461,-113.4938], 9);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:18}).addTo(map);
    let sourceCenter = L.latLng(53.5461, -113.4938);
    const marker = L.marker(sourceCenter, {draggable:true}).addTo(map).bindTooltip('Source', {permanent:true, direction:'top', offset:[0,-18]});
    marker.on('move', e => { sourceCenter = e.latlng; });

    // --- Canvas overlay ---
    const canvas = document.createElement('canvas');
    canvas.style.position = 'absolute'; canvas.style.top = 0; canvas.style.left = 0;
    map.getPanes().overlayPane.appendChild(canvas);
    const ctx = canvas.getContext('2d');

    function resizeCanvas(){
      const s = map.getSize();
      canvas.width = s.x; canvas.height = s.y;
      const pos = map._getMapPanePos();
      L.DomUtil.setPosition(canvas, pos.multiplyBy(-1));
      if (particles.length) draw();
    }
    map.on('resize zoom move', resizeCanvas);
    resizeCanvas();

    // --- Wind + UI ---
    const windStat = document.getElementById('windStat');
    const fpsEl = document.getElementById('fps');
    const manualEl = document.getElementById('manualWind');
    const wsEl = document.getElementById('windSpeed');
    const wdEl = document.getElementById('windDir');

    function updateManualWind(){
      const rad = manualDir*Math.PI/180;
      wind = { u: -manualSpeed*Math.sin(rad), v: -manualSpeed*Math.cos(rad), speed: manualSpeed, dir: manualDir };
      windStat.textContent = `wind: ${manualSpeed.toFixed(1)} m/s from ${manualDir.toFixed(0)}° (manual)`;
    }

    manualEl.onchange = () => { manual = manualEl.checked; if (manual) updateManualWind(); };
    wsEl.oninput = () => { manualSpeed = parseFloat(wsEl.value); if (manual) updateManualWind(); };
    wdEl.oninput = () => { manualDir = parseFloat(wdEl.value); if (manual) updateManualWind(); };

    // --- Particles ---
    function jitter(ll, meters=200){
      const r = meters*Math.sqrt(Math.random()), th = Math.random()*Math.PI*2;
      const dy = r*Math.sin(th), dx = r*Math.cos(th);
      const dlat = (dy/R)*toDeg, dlon = (dx/(R*Math.max(1e-6, Math.cos(ll.lat*Math.PI/180))))*toDeg;
      return L.latLng(ll.lat+dlat, ll.lng+dlon);
    }

    function spawn(n){
      for(let i=0;i<n;i++){
        const ll = jitter(sourceCenter, 200);
        particles.push({lat: ll.lat, lon: ll.lng, age: 0, trail: []});
      }
    }

    function step(dt){
      if (manual) updateManualWind();
      const u = wind.u, v = wind.v;
      for (let p of particles){
        if (maxTrail>0){
          p.trail.push([p.lat, p.lon]);
          if (p.trail.length>maxTrail) p.trail.shift();
        }
        const coslat = Math.cos(p.lat*Math.PI/180);
        p.lat += (v/R)*toDeg*dt;
        p.lon += (u/(R*Math.max(1e-6,coslat)))*toDeg*dt;
        p.age += dt;
        if (p.age > maxLifesec){
          const ll = jitter(sourceCenter, 200);
          p.lat = ll.lat; p.lon = ll.lng; p.age = 0; p.trail.length = 0;
        }
      }
    }

    function draw(){
      const s = map.getSize();
      ctx.clearRect(0,0,s.x,s.y);
      ctx.lineWidth = 1;
      for (let p of particles){
        if (p.trail.length>1){
          ctx.beginPath();
          const pt0 = map.latLngToLayerPoint(p.trail[0]); ctx.moveTo(pt0.x, pt0.y);
          for (let i=1;i<p.trail.length;i++){
            const pti = map.latLngToLayerPoint(p.trail[i]); ctx.lineTo(pti.x, pti.y);
          }
          ctx.strokeStyle = 'rgba(80,80,80,0.35)'; ctx.stroke();
        }
        const pt = map.latLngToLayerPoint([p.lat, p.lon]);
        ctx.beginPath(); ctx.arc(pt.x, pt.y, 1.6, 0, Math.PI*2);
        ctx.fillStyle = 'rgba(30,30,30,0.85)'; ctx.fill();
      }
    }

    // --- Animation ---
    let last = performance.now(), frames=0, acc=0;
    function animate(){
      const now = performance.now();
      const dt = Math.min(0.05, (now-last)/1000);
      last = now;
      if (running){
        step(dt);
        draw();
        frames++; acc += dt;
        if (acc >= 0.5){ fpsEl.textContent = `fps: ${(frames/acc).toFixed(0)}`; frames=0; acc=0; }
      }
      requestAnimationFrame(animate);
    }
    requestAnimationFrame(animate);

    // --- Buttons ---
    document.getElementById('start').onclick = () => { running = true; last = performance.now(); console.log("plume: started"); };
    document.getElementById('stop').onclick  = () => { running = false; console.log("plume: stopped"); };

    // Seed + init UI + autostart
    spawn(600);
    updateManualWind();
    draw();
    running = true;  // AUTOSTART for sanity
    console.log("plume: initialized, particles:", particles.length);
  });
  </script>
</body>
</html>
